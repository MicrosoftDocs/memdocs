---
author: aczechowski
ms.author: aaroncz
ms.prod: configuration-manager
ms.technology: configmgr-core
ms.topic: include
ms.date: 05/26/2020
---

## <a name="bkmk_pwshcmg"></a> Improvements to cloud management gateway cmdlets

<!--6978300-->

With more customers managing remote devices now, this release includes several new Windows PowerShell cmdlets for the cloud management gateway (CMG). You can use these cmdlets to automate the creation, configuration, and management of the CMG service and Azure Active Directory (Azure AD) requirements.

For more information about the CMG, see [Plan for the cloud management gateway](../../../../clients/manage/cmg/plan-cloud-management-gateway.md).

For more information on using PowerShell with Configuration Manager, see [Get started with Configuration Manager cmdlets](https://docs.microsoft.com/powershell/sccm/overview?view=sccm-ps).

### Existing cmdlets

You can continue to use the following existing cmdlets:

- [Add-CMCloudManagementGatewayConnectionPoint](https://docs.microsoft.com/powershell/module/configurationmanager/Add-CMCloudManagementGatewayConnectionPoint?view=sccm-ps)
- [Get-CMCloudManagementGateway](https://docs.microsoft.com/powershell/module/configurationmanager/Get-CMCloudManagementGateway?view=sccm-ps)
- [Get-CMCloudManagementGatewayConnectionPoint](https://docs.microsoft.com/powershell/module/configurationmanager/Get-CMCloudManagementGatewayConnectionPoint?view=sccm-ps)
- [New-CMCloudManagementGateway](https://docs.microsoft.com/powershell/module/configurationmanager/New-CMCloudManagementGateway?view=sccm-ps)
- [Remove-CMCloudManagementGateway](https://docs.microsoft.com/powershell/module/configurationmanager/Remove-CMCloudManagementGateway?view=sccm-ps)
- [Remove-CMCloudManagementGatewayConnectionPoint](https://docs.microsoft.com/powershell/module/configurationmanager/Remove-CMCloudManagementGatewayConnectionPoint?view=sccm-ps)
- [Set-CMCloudManagementGateway](https://docs.microsoft.com/powershell/module/configurationmanager/Set-CMCloudManagementGateway?view=sccm-ps)
- [Set-CMCloudManagementGatewayConnectionPoint](https://docs.microsoft.com/powershell/module/configurationmanager/Set-CMCloudManagementGatewayConnectionPoint?view=sccm-ps)
- [Start-CMCloudManagementGateway](https://docs.microsoft.com/powershell/module/configurationmanager/Start-CMCloudManagementGateway?view=sccm-ps)
- [Stop-CMCloudManagementGateway](https://docs.microsoft.com/powershell/module/configurationmanager/Stop-CMCloudManagementGateway?view=sccm-ps)

The following existing cmdlets have significant improvements. For more information, see the sections below:

- [New-CMCloudManagementGateway](#new-cmcloudmanagementgateway)
- [Set-CMCloudManagementGateway](#set-cmcloudmanagementgateway)

### New cmdlets

#### Get-CMAzureService

Use this cmdlet to get the Azure service.

<!-- Questions
- is this the CM Azure service? e.g., https://docs.microsoft.com/en-us/mem/configmgr/core/servers/deploy/configure/azure-services-wizard
- example of name and ID? format? how to find in console?
-->

##### Example 1: Get the Azure service by name

```powershell
Get-CMAzureService -Name $azureServiceName
```

##### Example 2: Get the Azure service by ID

```powershell
Get-CMAzureService -Id $azureServiceId
```

#### Remove-CMAzureService

Use this cmdlet to remove the Azure service.

##### Example 1: Remove the Azure service by name

```powershell
Remove-CMAzureService -Name $azureServiceName
```

##### Example 2: Force remove the Azure service by its ID

```powershell
Remove-CMAzureService -Id $azureServiceId -Force
```

##### Example 3: Get the Azure service by name and then remove it

```powershell
Get-CMAzureService -Name $azureServiceName | Remove-CMAzureService
```

#### Get-CMAADApplication

Use this cmdlet to get the Azure AD application.

<!-- Questions
- is this for any AAD app, or specifically the one for CMG?
- example tenant name? format? how to find in console/portal?
- example app name?
 -->

##### Example 1: Get the Azure AD client application by tenant name

```powershell
Get-CMAADApplication -TenantName $tenantName -AppType ClientApplication
```

##### Example 2: Get the Azure AD server application by tenant ID

```powershell
Get-CMAADApplication -TenantId 08115B35-38B4-4CFF-B36C-34F559E09271 -AppType ServerApplication
```

##### Example 3: Get the Azure AD application by its name

```powershell
Get-CMAADApplication -AppName $applicationName
```

#### Import-CMAADServerApplication

Use this cmdlet to import the web/server app to Azure AD.

<!-- Questions
- format for variables?
 -->

```powershell
$date =(Get-Date).Date.AddDays(3)

Import-CMAADServerApplication -TenantName $tenantName -TenantId $tenantId -AppName $appName -ClientId $clientId -SecretKey $secretKey -SecretKeyExpiry $date
```

#### Import-CMAADClientApplication

Use this cmdlet to import the client app to Azure AD.

<!-- Questions
- what's the difference between the two examples? 
- tenant ID is just the guid
- what's the clientId variable?
- what's the serverApp variable?
 -->

##### Example 1: Import the client app ...

```powershell
Import-CMAADClientApplication -TenantId $tenantId -AppName $appName -ClientId $clientId
```

##### Example 2: Import the client app...

```powershell
Import-CMAADClientApplication -ServerApp $serverApp -AppName $appName -ClientId $clientId
```

#### New-CMCloudManagementAzureService

Use this cmdlet to create the Azure service in Configuration Manager for **Cloud Management**.

<!-- questions
- is there an expected order of operations for these cmdlets?
 -->

```powershell
$serverApp = Get-CMAADApplication -TenantName $tenantName -AppType ServerApplication -AppName $serverAppName

$clientApp = Get-CMAADApplication -TenantName $tenantName -AppType ClientApplication -AppName $clientAppName

New-CMCloudManagementAzureService -Name $azureServerName -Description "Azure Service" -ServerApp $serverApp -ClientApp $clientApp -AzureEnvironmentOption AzurePublicCloud
```

#### Set-CMCloudManagementAzureService

Use this cmdlet to modify the settings of the Azure service in Configuration Manager for **Cloud Management**.

```powershell
Get-CMAzureService -Name $azureServiceName | Set-CMCloudManagementAzureService -NewName $azureServiceNewName -Description "New description"
```

### Updated cmdlets

#### New-CMCloudManagementGateway

This existing cmdlet includes the following new parameters:

- **EnvironmentSetting**: Specify the Azure environment, for example `AzurePublicCloud`

- **ServerAppClientID**: Specify the client ID of the Azure AD server app. Use this parameter for non-user interaction mode. In the CMG properties, this value is the **Azure AD app name**.

- **ServiceCertPath**: Specify the [CMG server authentication certificate](https://docs.microsoft.com/en-us/mem/configmgr/core/clients/manage/cmg/certificates-for-cloud-management-gateway#bkmk_serverauth).

- **ServiceCertPassword**: Specify the password for the service certificate.

- **ServiceName**: Specify the Azure service name. <!-- i thought this value comes from the cert? -->

- **Region**: Specify the Azure service region, for example: ...

- **IsUsingExistingGroup**: Specify if the Azure resource group already exists.

- **GroupName**: Specify the name of the Azure resource group.

- **VMInstanceCount**: Specify the instance count of virtual machines.

- **CheckClientCertRevocation**: Enable or disable the option to **Verify client certificate revocation**.

- **EnforceProtocol**: Enable or disable the option to **Enforce TLS 1.2**.

- **EnableCloudDPFunction**: Enable or disable the option to **Allow CMG to function as a cloud distribution point and serve content from Azure storage**.

- **EnableTrafficOut**: Enable or disable the option to **Turn on 14-day threshold and alerts for monitoring outbound data transfer**.

- **TrafficOutStopService**: Enable or disable the option to **Stop this service when the critical threshold is exceeded**.

    > [!TIP]
    > Use the following existing parameters to configure the specific threshold amount and alert percentages: **TrafficOutGB**, **TrafficWarningPct**, **TrafficCriticalPct**.

- **EnableStorageQuota**: Enable or disable the option to **Specify storage alert threshold**.

- **StorageQuotaGB**: Specify an integer value for the **Storage alert threshold (GB)**. For example, `2`.

- **StorageWarningPct**: Specify an integer value for the **Generate Warning alert (% of storage alert threshold)**. For example, `50`.

- **StorageCriticalPct**: Specify an integer value for the **Generate Critical alert (% of storage alert threshold)**. For example, `90`.

- **CARootCert**: Add root certificates to the cloud service.

- **Force**: force certificate warning <!-- huh? -->

##### Example 1

```powershell
$Path = "c:\TestPath\$RootCA.cer"

$Type = [Microsoft.ConfigurationManagement.AdminConsole.AzureServices.CertificateStore]::RootCA

$Cert =@{$Path = $Type}

$Password = "$PasswordString” | ConvertTo-SecureString -AsPlainText -Force

New-CMCloudManagementGateway -ServiceCertPath "c:\TestPath\$CommonName.pfx" -EnvironmentSetting AzurePublicCloud -SubscriptionId $SubscriptionId -ServiceCertPassword $Password -ServiceName $CommonName -Description $Description -Region EastUS -VMInstanceCount $InstanceCount -CARootCert $Cert -CheckClientCertRevocation $False -EnforceProtocol $True -IsUsingExistingGroup $true -GroupName $ExistingGroupName
```

##### Example 2

```powershell
New-CMCloudManagementGateway -ServiceCertPath "c:\TestPath\$CommonName.pfx" -EnvironmentSetting AzurePublicCloud -SubscriptionId $SubscriptionId -ServiceCertPassword $Password -ServiceName $CommonName -Description $Description -Region EastUS -VMInstanceCount $InstanceCount -CARootCert $Cert -CheckClientCertRevocation $False -EnforceProtocol $True -GroupName test -EnableCloudDPFunction $true -EnableTrafficOut $true -TrafficOutStopService $true -TrafficOutGB $TrafficOutGB -TrafficWarningPct $ TrafficWarningPercent -TrafficCriticalPct $TrafficCriticalPercent-EnableStorageQuota $true -StorageQuotaGB $StorageQuotaGB -StorageWarningPct $StorageWarningPercent -StorageCriticalPct $StorageCriticalPercent -Force
```
<!-- a lot of variables in examples, can we change to actual values to show the format? -->

#### Set-CMCloudManagementGateway

This existing cmdlet includes the following new parameters. For more information on these parameters, see the descriptions in the section for [New-CMCloudManagementGateway](#new-cmcloudmanagementgateway).

- EnableTrafficOut
- TrafficOutStopService
- EnableStorageQuota
- StorageQuotaGB
- StorageWarningPct
- StorageCriticalPct
- EnforceProtocol
- CARootCert
- RemoveCertThumbprints
- EnableCloudDPFunction

##### Example 1: Change the CMG alerts configuration

```powershell
Set-CMCloudManagementGateway -Name $CMGname -EnableTrafficOut $true -TrafficOutGB $TrafficOutGB -TrafficWarningPct $TrafficWarningPct –TrafficCriticalPct $TrafficCriticalPct -EnableStorageQuota $true -StorageQuotaGB $StorageQuotaGB -StorageWarningPct $StorageWarningPct -StorageCriticalPct $StorageCriticalPct
```

##### Example 2: Change the number of virtual machines for the CMG service

```powershell
Set-CMCloudManagementGateway -Name $CMGname -VMInstancesCount $VMInstancesCount
```

##### Example 3: Enable the CMG to serve content from Azure storage

```powershell
Set-CMCloudManagementGateway -Name $CMGname -EnableCloudDPFunction $EnableCloudDPFunction
```

##### Example 4: Add two new certificate authorities

```powershell
$path1 = "folder\root.cer"
$type1 = [Microsoft.ConfigurationManagement.AdminConsole.AzureServices.CertificateStore]::RootCA

$path2 = "folder\intermediate.cer"
$type2 = [Microsoft.ConfigurationManagement.AdminConsole.AzureServices.CertificateStore]::IntermediateCA

$cert = @{$path1 = $type1; $path2 = $type2}

Set-CMCloudManagementGateway -Name $CMGname -CARootCert $cert
```

##### Example 5: Update the CMG server authentication certificate

```powershell
Set-CMCloudManagementGateway -Name $CMGname -ServiceCertPath $ServiceCertPath -ServiceCertPassword (ConvertTo-SecureString "$password"-AsPlainText -Force)
```

##### Example 6

<!-- what is this? -->

```powershell
Set-CMCloudManagementGateway -Name $CMGname -RemoveCertThumbprints $string
```
